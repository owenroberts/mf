!function(){"use strict";window.Doodoo=function(t,n){let e,o=t.debug,a=!1,r=t.duration||"4n",s=t.scale||[0,2,4,5,7,9,11],c=t.voices||[t.samples];0===c.length&&c.push("FMSynth");let i,l,u=t.withRecording;u&&(i=new Tone.Recorder,l=+prompt("Record number of mutations?",10));let p="string"==typeof t.tonic?t.tonic:MIDI_NOTES[t.tonic];t.transform||(t.transform=t.tonic);let f="string"==typeof t.transform?t.transform:MIDI_NOTES[t.transform],m={...defaults,...t.controls},d=new Effects(m),h=[];if("string"==typeof t.parts[0]){const n=t.parts.map((t=>[t,r]));h.push(new Part(n,m,r,o))}else if("number"==typeof t.parts[0]){const n=t.parts.map((t=>[MIDI_NOTES[t],r]));h.push(new Part(n,m,r,o))}else if(Array.isArray(t.parts[0]))if(Array.isArray(t.parts[0][0]))for(let n=0;n<t.parts.length;n++){const e=t.parts[n];h.push(new Part(e,m,r,o));const a=t.parts[n].map((t=>parseInt(t[1])));r=Math.max(...a)+"n"}else{const n=t.parts;h.push(new Part(n,m,r,o));const e=t.parts.map((t=>parseInt(t[1])));r=Math.max(...e)+"n"}let T=0,y=0,g=t.simultaneous||!1;const D=new ValueRange(...m.attackStart),w=new ValueRange(...m.attackStep),E=new ValueRange(...m.restChance);let M,S=[],$=0,v=0;const I=t.useMetro;let b;async function R(){try{await Tone.start(),c.filter((t=>!t.includes("Synth"))).length>0?function(t){let n=function(){let t={};return c.forEach((n=>{if("choir"===n)"AEIOU".split("").forEach((e=>{const o=SamplePaths["choir"+e];for(const a in o)t[`${n}-${e}-${a}`]=`${n}/${e}/${o[a]}`}));else for(const e in SamplePaths[n])t[`${n}-${e}`]=`${n}/${SamplePaths[n][e]}`})),t}();console.time(`load ${c.join(", ")}`),e=new Tone.ToneAudioBuffers({urls:n,baseUrl:"../samples/",onload:()=>{console.timeEnd(`load ${c.join(", ")}`),t&&t()}})}(P):P()}catch(t){console.error("load tone error",t)}}function P(){n&&n(),M=new Tone.Loop(O,r),Tone.Transport.start(),t.bpm&&(Tone.Transport.bpm.value=t.bpm),M.start(Tone.Transport.seconds),A(),I&&(b=new Tone.MetalSynth({volume:-12,frequency:250,envelope:{attack:.01,decay:.01,release:.2},harmonicity:3.1,modulationIndex:32,resonance:4e3,octaves:1.5}).toDestination()),a=!0,u&&i.start()}function A(){v=0,S=[];let n=g?h:[h[T]];n.forEach((t=>{t.getLoops().forEach((t=>{const n={...t,melody:0===t.harmony?getMelody(t.melody,p,f):getHarmony(t.melody,p,f,t.harmony,s),voice:x(random(c))};S.push(n)}))})),S.forEach((t=>{let n=[];t.melody.forEach((t=>{const[e,o]=t;let a=+r[0]/+o[0];o.includes(".")&&(a*=1.5),n.push(t);for(let t=1;t<a;t++)n.push([null,r])})),t.melody=n,t.countNum=t.doubler?t.counter*t.noteDuration/4:1,t.countEnd=(t.melody.length-1)*t.repeat+t.startDelay,t.len=t.melody.length})),$=Math.max(0,Math.max(...S.map((t=>t.melody.length))));let e=n.map((t=>t.update()))[0];t.onMutate&&t.onMutate(e),g||(T++,T>=h.length&&(T=0)),y++,"stopped"===Tone.Transport.state&&Tone.Transport.start(),e>l&&(Tone.Transport.stop(),a=!1,L())}function O(t){I&&b.triggerAttackRelease("C4","4n",t,.1);let n=D.getRandom();for(let e=0;e<S.length;e++){const o=S[e];if(!(o.count>o.countEnd)){for(let e=0;e<o.countNum;e++){if(o.count<o.startDelay)continue;if(o.count%1!=0&&!o.doubler)continue;if(chance(E.getRandom()))continue;const a=o.melody[Math.floor(o.count-o.startDelay+o.startIndex)%o.len];if(null!==a[0]){const[r,s]=a;let c=e?Tone.Time(`${o.noteDuration}n`).toSeconds()*e:0;o.voice.triggerAttackRelease(r,s,t+c,n)}o.doublerCounter&&(o.count+=o.counter)}(!o.doublerCounter||o.count<o.startDelay)&&(o.count+=o.counter)}}var e,o,a;n+=w.getRandom(),e=n,o=.1,a=1,n=Math.min(Math.max(e,o),a),v++,v===$&&A()}function x(n){return n.includes("Synth")?function(){const n=new Tone.FMSynth({volume:t.volume||0});u?n.chain(Tone.Destination,i):n.toDestination();return d.get(y).forEach((t=>{u?t.chain(Tone.Destination,i):t.toDestination(),n.connect(t)})),n}():function(n){const o=function(t){const n={};if("choir"===t){const o=y<3?"U":random("AEIOU".split(""));for(const a in SamplePaths[t+o])n[a]=e.get(`${t}-${o}-${a}`)}else for(const o in SamplePaths[t])n[o]=e.get(`${t}-${o}`);return n}(n),a=new Tone.Sampler({urls:o,volume:t.volume||0,release:1});u?a.chain(Tone.Destination,i):a.toDestination();return d.get(y).forEach((t=>{u?t.chain(Tone.Destination,i):t.toDestination(),a.connect(t)})),a}(n)}async function L(){const t=await i.stop(),n=URL.createObjectURL(t),e=document.createElement("a"),o=prompt("Name clip","Doodoo_"+(new Date).toDateString().replace(/ /g,"-"));e.download=o+".webm",e.href=n,e.click()}return t.lazyLoad||R(),{play:function(){if(!t.autoLoad)return R();"stopped"===Tone.Transport.state&&A(),a=!0,u&&i.start()},stop:function(){Tone.Transport.stop(),a=!1,u&&"started"===i.state&&L()},mutate:function(){h.forEach((t=>{t.update()}))},moveTonic:function(t){let n=MIDI_NOTES.indexOf(f)+t;f=MIDI_NOTES[n]},setTonic:function(t){f=t},moveBPM:function(t){let n=Tone.Transport.bpm.value;Tone.Transport.bpm.value=n+t},setBPM:function(t){Tone.Transport.bpm.value=t},getIsPlaying:function(){return a},isRecording:function(){return"started"===i.state||"paused"===i.state},printLoops:function(){console.log("loops",S)},getLoops:function(){return S}}}}();
//# sourceMappingURL=src_maps/doodoo.min.js.map
